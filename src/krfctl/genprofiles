#!/usr/bin/env ruby
# frozen_string_literal: true

# genprofiles: generate a lookup table of profiles names -> syscall lists

require "open3"
require "yaml"

PROFILE_SPEC = File.expand_path "profiles.yml", __dir__
OUTPUT_NAME = File.expand_path "profiles.gen.c", __dir__

PROFILES = YAML.safe_load File.read(PROFILE_SPEC)

def hai(msg)
  STDERR.puts "[genprofiles] #{msg}"
end

hai "building lookup table with #{PROFILES.size} entries"

File.open(OUTPUT_NAME, "w") do |file|
  file.puts <<~PREAMBLE
    /* WARNING!
     * This file was generated by KRF's genprofiles.
     * Do not edit it by hand.
     */

    #include <stdlib.h>

    #include "krfctl.h"
  PREAMBLE

  file.puts "fault_profile_t fault_profile_table[] = {"

  PROFILES.each do |name, syscalls|
    sys_struct = syscalls.map { |s| "\"#{s}\"" }.join ", "
    file.puts %({ "#{name}", { #{sys_struct}, NULL } },)
  end

  file.puts "{ NULL, { NULL } },"
  file.puts "};"
end
